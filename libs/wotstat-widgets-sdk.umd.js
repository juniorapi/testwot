(function(c,h){typeof exports=="object"&&typeof module<"u"?h(exports):typeof define=="function"&&define.amd?define(["exports"],h):(c=typeof globalThis<"u"?globalThis:c||self,h(c.WotstatWidgetsSdk={}))})(this,function(c){"use strict";var W=Object.defineProperty;var j=(c,h,C)=>h in c?W(c,h,{enumerable:!0,configurable:!0,writable:!0,value:C}):c[h]=C;var d=(c,h,C)=>j(c,typeof h!="symbol"?h+"":h,C);function h(s=new Map){const e=new Map(s),t=new Map;function r(i){return{get(l,n,p){if(n==="value")return e.get(i);if(n==="watch")return(y,E)=>(t.has(i)?t.get(i).add(y):t.set(i,new Set([y])),E!=null&&E.immediate&&y(e.get(i),e.get(i)),()=>{t.get(i).delete(y),t.get(i).size===0&&t.delete(i)});const a=i==""?n.toString():`${i}.${n.toString()}`;return new Proxy({},r(a))}}}const o=Symbol("notSet");function u(i,l,n=o){const p=n==o?e.get(i):n;e.set(i,l);const a=t.get(i);if(a)for(const y of a)y(l,p)}function g(i,l){const n=t.get(i);if(n)for(const p of n)p(l)}function f(i=new Map){for(const[l,n]of e.entries())i.has(l)?u(l,i.get(l)):u(l,void 0);for(const[l,n]of i.entries())e.has(l)||u(l,n)}return{proxy:new Proxy(e,r("")),update:u,trigger:g,resetup:f}}function C(s){return!(typeof s!="object"||s===null||!("type"in s)||s.type!=="init"||!("states"in s)||!Array.isArray(s.states))}function M(s){return!(typeof s!="object"||s===null||!("type"in s)||s.type!=="state"||!("path"in s)||!("value"in s))}function $(s){return!(typeof s!="object"||s===null||!("type"in s)||s.type!=="trigger"||!("path"in s))}const R="#4ee100",v="#292929",_="accent",H="background",P=":root{--wotstat-background: #292929;--wotstat-accent: #4ee100;--wotstat-primary: #ffffff;--wotstat-secondary: #c4c4c4;--wotstat-separator: #c4c4c466}body{margin:0;padding:0;font-family:Arial,sans-serif}.widgets-sdk-styles hr{margin:.5em 0;border:0;height:.05em;background:var(--wotstat-secondary);border-radius:1em;opacity:.4}.wotstat-background,.widgets-sdk-styles .background{background-color:var(--wotstat-background)}.wotstat-accent,.widgets-sdk-styles .accent{color:var(--wotstat-accent)}.wotstat-primary,.widgets-sdk-styles .primary{color:var(--wotstat-primary)}.wotstat-secondary,.widgets-sdk-styles .secondary{color:var(--wotstat-secondary)}.wotstat-number,.widgets-sdk-styles .number{text-wrap:none;white-space:nowrap;font-variant-numeric:tabular-nums}.wotstat-autoscale,.widgets-sdk-styles .autoscale{font-size:4vw}.wotstat-card,.widgets-sdk-styles .card{background-color:var(--wotstat-background);color:var(--wotstat-primary);margin:0;padding:1em;border-radius:1em}";function D(){const s=history.pushState,e=history.replaceState;history.pushState=function(t,r,o){const u=s.apply(history,arguments);return window.dispatchEvent(new Event("locationchange")),u},history.replaceState=function(t,r,o){const u=e.apply(history,arguments);return window.dispatchEvent(new Event("locationchange")),u},window.addEventListener("popstate",()=>{window.dispatchEvent(new Event("locationchange"))})}function S(s){const e=s.split("?")[1];if(!e)return;const t=e.split("&").map(f=>f.split("=")),r=new Map(t),o=(f,i)=>{const l=r.get(f)??i;return l.startsWith("#")?l:`#${l}`},u=o(_,R),g=o(H,v);document.documentElement.style.setProperty("--wotstat-accent",u),document.documentElement.style.setProperty("--wotstat-background",g)}function b(){document.head.insertAdjacentHTML("beforeend",`<style>${P}</style>`)}function I(){b(),D();let s=window.location.href;window.addEventListener("locationchange",()=>{window.location.href!==s&&(s=window.location.href,S(s))}),S(s)}class k{constructor(e,t,r){this.path=e,this.value=t,this.onUpdate=r}get(){return this.value}set(e){this.value!==e&&(this.value=e,this.onUpdate(e))}}class N{constructor(e,t){this.path=e,this.onUpdate=t}trigger(e){this.onUpdate(e)}}class T{constructor(e,t,r,o){d(this,"api",{connect:()=>this.connect(),connectAndInit:e=>this.connectAndInit(e),disconnect:()=>this.disconnect(),onInit:e=>this.onInit(e),createState:(e,t)=>this.createState(e,t),createTrigger:e=>this.createTrigger(e),changeState:(e,t)=>this.changeState(e,t),trigger:(e,t)=>this.trigger(e,t),registerExtension:e=>this.registerExtension(e)});d(this,"registeredExtensions");this.onMessage=t,this.onConnect=r,this.onDisconnect=o}connect(){this.onConnect()}connectAndInit(e){this.onConnect(),this.onInit(e),this.registeredExtensions=new k("registeredExtensions",[],t=>{this.onMessage({type:"state",path:"registeredExtensions",value:t})})}disconnect(){this.onDisconnect()}onInit(e){const t=e?Object.entries(e).map(([r,o])=>({path:r,value:o})):[];this.onMessage({type:"init",states:t})}createState(e,t){const r=new k(e,t,o=>{this.onMessage({type:"state",path:e,value:o})});return{get:()=>r.get(),set:o=>r.set(o)}}createTrigger(e){const t=new N(e,r=>{this.onMessage({type:"trigger",path:e,value:r})});return{trigger:r=>t.trigger(r)}}registerExtension(e){this.registeredExtensions&&this.registeredExtensions.set([...this.registeredExtensions.get(),e])}changeState(e,t){this.onMessage({type:"state",path:e,value:t})}trigger(e,t){this.onMessage({type:"trigger",path:e,value:t})}}const A="wotstat-widget:";function m(s,e="true"){const t=A+s;if(document.head.querySelector(`meta[name="${t}"]`)){if(e==="true")return;const o=document.head.querySelector(`meta[name="${t}"]`);o.content=e;return}const r=document.createElement("meta");r.name=t,r.content=e,document.head.appendChild(r)}function w(s){const e=document.head.querySelector(`meta[name="${A+s}"]`);e&&e.remove()}c.WidgetMetaTags=void 0,(s=>{function e(n){n?m("auto-height"):w("auto-height")}s.setAutoHeight=e;function t(n){n?m("hangar-only"):w("hangar-only")}s.setHangarOnly=t;function r(n){n?m("ready-to-clear-data"):w("ready-to-clear-data")}s.setReadyToClearData=r;function o(n){n?m("use-sniper-mode"):w("use-sniper-mode")}s.setUseSniperMode=o;function u(n){n?m("preferred-top-layer"):w("preferred-top-layer")}s.setPreferredTopLayer=u;function g(n){n?m("unlimited-size"):w("unlimited-size")}s.setUnlimitedSize=g;function f(n){if(typeof n=="object"){const{top:p=0,right:a=0,bottom:y=0,left:E=0}=n;n=`${p} ${a} ${y} ${E}`}else if(typeof n=="number")n=`${n} ${n} ${n} ${n}`;else if(typeof n=="string"){const a=n.trim().split(/\s\s*/).map(y=>parseFloat(y));a.length==1?n=`${a[0]} ${a[0]} ${a[0]} ${a[0]}`:a.length==2?n=`${a[0]} ${a[1]} ${a[0]} ${a[1]}`:a.length==3?n=`${a[0]} ${a[1]} ${a[2]} ${a[1]}`:a.length==4&&(n=`${a[0]} ${a[1]} ${a[2]} ${a[3]}`)}console.log(n),n===!1||n==="0 0 0 0"?w("insets"):m("insets",n)}s.setInsets=f;function i(){m("auto-height")}s.enableAutoHeight=i;function l(){w("auto-height")}s.disableAutoHeight=l})(c.WidgetMetaTags||(c.WidgetMetaTags={}));class L{constructor(){d(this,"onClearDataCallbacks",new Map);document.readyState==="complete"?this.setup():document.addEventListener("readystatechange",()=>{document.readyState==="complete"&&this.setup()})}setup(){window.addEventListener("wotstat-widget-command",e=>{"detail"in e&&typeof e.detail=="string"&&this.processEvent(e.detail)})}processEvent(e){switch(e){case"CLEAR_DATA":for(const t of this.onClearDataCallbacks.keys())t();break}}onClearData(e){this.onClearDataCallbacks.set(e,!1);const t=()=>{c.WidgetMetaTags.setReadyToClearData([...this.onClearDataCallbacks.values()].some(Boolean))};return{setReadyToClearData:r=>{this.onClearDataCallbacks.set(e,r),t()},unsubscribe:()=>{this.onClearDataCallbacks.delete(e),t()}}}forceClearData(){this.processEvent("CLEAR_DATA")}}const O=new L;function x(s){try{return JSON.parse(s)}catch{return null}}class U{constructor(e){d(this,"websocket",null);d(this,"_status","connecting");d(this,"onStatusChangeCallbacks",new Set);d(this,"onAnyChangeCallbacks",new Set);d(this,"onAnyTriggerCallbacks",new Set);d(this,"dataProxy",h());d(this,"port",33800);d(this,"host","localhost");d(this,"onClose",e=>{this.reconnect()});d(this,"onMessage",e=>{const t=x(e.data);if(t)if(C(t))this.onInitMessage(t);else if(M(t)){this.dataProxy.update(t.path,t.value);for(const r of this.onAnyChangeCallbacks)r(t.path,t.value)}else if($(t)){this.dataProxy.trigger(t.path,t.value);for(const r of this.onAnyTriggerCallbacks)r(t.path,t.value)}else console.error("Unknown message type",t)});this.port=(e==null?void 0:e.wsPort)??38200,this.host=(e==null?void 0:e.wsHost)??"localhost",(e==null?void 0:e.connect)!==!1&&this.reconnect(),(e==null?void 0:e.style)!==!1&&I();const t=new T(this,r=>{const o=new MessageEvent("message",{data:JSON.stringify(r)});this.onMessage(o)},()=>this.closeConnection(),()=>{this.status="connecting"});window.wotstatEmulator=t.api}get status(){return this._status}set status(e){if(this._status!==e){this._status=e;for(const t of this.onStatusChangeCallbacks)t(e)}}get data(){return this.dataProxy.proxy}get commands(){return O}dispose(){this.closeConnection(),this.websocket=null}onStatusChange(e,t){return this.onStatusChangeCallbacks.add(e),t!=null&&t.immediate&&e(this.status),()=>this.onStatusChangeCallbacks.delete(e)}onAnyChange(e){return this.onAnyChangeCallbacks.add(e),()=>this.onAnyChangeCallbacks.delete(e)}onAnyTrigger(e){return this.onAnyTriggerCallbacks.add(e),()=>this.onAnyTriggerCallbacks.delete(e)}closeConnection(){this.websocket!==null&&(this.websocket.removeEventListener("message",this.onMessage),this.websocket.removeEventListener("close",this.onClose),this.websocket.close())}reconnect(){this.closeConnection(),this.status="connecting",this.websocket=new WebSocket(`ws://${this.host}:${this.port}`),this.websocket.addEventListener("message",this.onMessage),this.websocket.addEventListener("close",this.onClose)}onInitMessage(e){const t=new Map(e.states.map(({path:r,value:o})=>[r,o]));this.dataProxy.resetup(t),this.status="connected"}}const G={en:{shortShellNames:{HOLLOW_CHARGE:"HEAT",ARMOR_PIERCING:"AP",ARMOR_PIERCING_HE:"HE",ARMOR_PIERCING_CR:"APCR",SMOKE:"SMOKE",HE_MODERN:"HE",HE_LEGACY_STUN:"HE",HE_LEGACY_NO_STUN:"HE",FLAME:"FLAME"}},ru:{shortShellNames:{HOLLOW_CHARGE:"КС",ARMOR_PIERCING:"ББ",ARMOR_PIERCING_HE:"ОФ",ARMOR_PIERCING_CR:"БП",SMOKE:"Дым",HE_MODERN:"ОФ",HE_LEGACY_STUN:"ОФ",HE_LEGACY_NO_STUN:"ОФ",FLAME:"Огонь"}}};c.I18n=void 0,(s=>{function e(r,o="en"){const u=r.split(".");let g=G[o];for(const f of u)if(f in g)g=g[f];else throw new Error(`Key: ${r} not found in translation`);return g}s.t=e;function t(r,o="en"){return e(`shortShellNames.${r}`,o)}s.shortShellName=t})(c.I18n||(c.I18n={})),c.WidgetSDK=U,c.setupStyles=b,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=wotstat-widgets-sdk.umd.js.map
